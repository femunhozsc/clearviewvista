<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clearview Vista - Análise de Ativos</title>
    
    <link rel="icon" type="image/png" href="favicon.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="data_loader.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        body { background-color: #050505; font-family: 'Roboto', sans-serif; }
        body::before {
            content: ''; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%; z-index: -1; pointer-events: none;
            background: radial-gradient(circle at 20% 15%, rgba(250, 204, 21, 0.15), transparent 40%),
                        radial-gradient(circle at 80% 85%, rgba(250, 204, 21, 0.12), transparent 50%);
            filter: blur(80px);
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #18181b; }
        ::-webkit-scrollbar-thumb { background: #52525b; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #facc15; }
        .loader { border-top-color: #facc15; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .fade-in-up { animation: fadeInUp 0.7s ease-in-out forwards; opacity: 0; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .card-background {
            position: relative; overflow: hidden;
            background-color: rgba(24, 24, 27, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 1rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card-hover:hover { 
            transform: translateY(-8px) scale(1.02);
            border-color: rgba(250, 204, 21, 0.5);
            box-shadow: 0 0 20px rgba(250, 204, 21, 0.15);
        }
        [style*="--animation-delay"] { animation-delay: var(--animation-delay); }
        .dropdown:hover .dropdown-menu { display: block; }
        .dropdown-menu { transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out; }
        #suggestion-box, .suggestion-box { 
            max-height: 300px; 
            overflow-y: auto; 
            z-index: 9999 !important;
            position: absolute;
            background: rgba(24, 24, 27, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 0.75rem;
        }
        #rankingModal.hidden { display: none; }
        
        /* Melhorias para gráficos responsivos */
        .chart-container {
            position: relative;
            width: 100%;
            height: 300px;
        }
        
        @media (max-width: 768px) {
            .chart-container {
                height: 250px;
            }
            
            .period-buttons {
                flex-wrap: wrap;
                gap: 0.25rem;
            }
            
            .period-buttons button {
                font-size: 0.75rem;
                padding: 0.375rem 0.75rem;
                min-width: 2.5rem;
            }
        }
        
        /* Otimizações de performance */
        .suggestion-item, .suggestion-item-comparador {
            will-change: background-color;
        }
        
        canvas {
            max-width: 100%;
            height: auto !important;
        }
        
        /* Melhor responsividade para tabelas */
        @media (max-width: 640px) {
            .comparison-table {
                font-size: 0.875rem;
            }
            
            .comparison-table .grid-cols-3 {
                gap: 0.5rem;
            }
        }
    </style>
</head>
<body class="bg-black text-gray-200 font-sans">
    <header class="bg-black/70 backdrop-blur-lg shadow-lg sticky top-0 z-50 border-b border-zinc-800">
        <nav class="container mx-auto px-6 py-3 flex justify-between items-center">
            <a href="/" class="flex items-center flex-shrink-0 transition-transform hover:scale-105">
                <img src="logo.png" alt="Clearview Vista Logo" class="h-12"> 
            </a>

            <div class="hidden md:flex flex-1 justify-center items-center space-x-6 text-gray-300 font-medium">
                <div class="relative dropdown">
                    <button class="hover:text-amber-400 transition-colors flex items-center py-2">Ações <svg class="w-4 h-4 ml-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></button>
                    <div class="dropdown-menu absolute hidden bg-zinc-800 rounded-md shadow-xl top-full mt-0 py-2 w-48 border border-zinc-700">
                        <a href="/comparador" class="block px-4 py-2 text-sm text-gray-300 hover:bg-zinc-700 hover:text-amber-400">Comparador de Ativos</a>
                        <a href="/simulador" class="block px-4 py-2 text-sm text-gray-300 hover:bg-zinc-700 hover:text-amber-400">Simulador</a>
                    </div>
                </div>
                <div class="relative dropdown">
                     <button class="hover:text-amber-400 transition-colors flex items-center py-2">Fundos <svg class="w-4 h-4 ml-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></button>
                     <div class="dropdown-menu absolute hidden bg-zinc-800 rounded-md shadow-xl top-full mt-0 py-2 w-48 border border-zinc-700">
                        <a href="/comparador" class="block px-4 py-2 text-sm text-gray-300 hover:bg-zinc-700 hover:text-amber-400">Comparador</a>
                         <a href="/simulador" class="block px-4 py-2 text-sm text-gray-300 hover:bg-zinc-700 hover:text-amber-400">Simulador</a>
                    </div>
                </div>
                <a href="#" class="hover:text-amber-400 transition-colors">Internacional</a>
                <a href="/noticias" class="hover:text-amber-400 transition-colors">Notícias</a>
                <a href="#" class="hover:text-amber-400 transition-colors">Carteiras</a>
            </div>

            <div class="flex items-center space-x-4">
                 <a href="#" class="hidden md:flex items-center space-x-2 text-gray-300 font-medium border border-transparent hover:border-amber-400 hover:text-amber-400 rounded-full px-4 py-2 transition-colors">
                     <span>Login</span>
                     <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                 </a>
                 <button id="hamburger-btn" class="md:hidden text-gray-300 hover:text-amber-400">
                     <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                 </button>
            </div>
        </nav>
    </header>
    
    <div id="mobile-menu" class="fixed top-0 right-0 h-full w-72 bg-zinc-900 shadow-lg z-[60] p-6 transition-transform duration-300 ease-in-out translate-x-full">
        <div class="flex justify-between items-center mb-12">
            <span class="text-white font-bold text-xl">Menu</span>
            <button id="close-menu-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button>
        </div>
        <nav class="flex flex-col space-y-2 text-lg">
            <h3 class="text-amber-400 font-semibold text-sm uppercase tracking-wider">Ações</h3>
            <a href="/comparador" onclick="fecharMenuMobile();" class="text-gray-300 hover:bg-zinc-800 rounded-md p-3 flex items-center space-x-3"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg><span>Comparador</span></a>
            <a href="/simulador" onclick="fecharMenuMobile();" class="text-gray-300 hover:bg-zinc-800 rounded-md p-3 flex items-center space-x-3"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg><span>Simulador</span></a>
            
            <h3 class="text-amber-400 font-semibold text-sm uppercase tracking-wider pt-4">Fundos</h3>
            <a href="/comparador" onclick="fecharMenuMobile();" class="text-gray-300 hover:bg-zinc-800 rounded-md p-3 flex items-center space-x-3"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg><span>Comparador</span></a>
            <a href="/simulador" onclick="fecharMenuMobile();" class="text-gray-300 hover:bg-zinc-800 rounded-md p-3 flex items-center space-x-3"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg><span>Simulador</span></a>
            
             <hr class="border-zinc-700 my-4">
             <a href="#" class="text-gray-300 hover:bg-zinc-800 rounded-md p-3 flex items-center space-x-3"><span>Internacional</span></a>
             <a href="/noticias" onclick="fecharMenuMobile();" class="text-gray-300 hover:bg-zinc-800 rounded-md p-3 flex items-center space-x-3"><span>Notícias</span></a>
             <a href="#" class="text-gray-300 hover:bg-zinc-800 rounded-md p-3 flex items-center space-x-3"><span>Carteiras</span></a>
            
             <div class="absolute bottom-6 left-6 right-6">
                 <a href="#" class="flex items-center justify-center space-x-2 text-gray-300 font-medium border border-zinc-700 hover:border-amber-400 hover:text-amber-400 rounded-full px-4 py-3 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    <span>Login</span>
                 </a>
             </div>
        </nav>
    </div>
    <div id="menu-overlay" class="fixed inset-0 bg-black bg-opacity-0 pointer-events-none z-50 transition-opacity duration-300"></div>


    <main id="main-container" class="container mx-auto p-6 md:p-8">
    </main>

    <footer class="bg-transparent mt-16 py-8 border-t border-zinc-800">
        <div class="container mx-auto text-center text-gray-500">
            <p>&copy; 2025 Clearview Capital. Todos os direitos reservados.</p>
        </div>
    </footer>

    <div id="rankingModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-[60]">
        <div class="card-background w-full max-w-2xl max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b border-zinc-800">
                <h3 id="modalTitle" class="text-xl font-bold text-white">Ranking Completo</h3>
                <button id="closeModalBtn" class="text-gray-400 hover:text-white">&times;</button>
            </div>
            <div id="modalContent" class="p-6 overflow-y-auto">
            </div>
        </div>
    </div>

    <script>
        // Variáveis globais
        const mainContainer = document.getElementById('main-container');
        let currentChart = null;
        let currentTicker = null;
        let listaAtivosCompleta = [];
        let debounceTimer;
        const apiUrl = 'https://clearview-api-y531.onrender.com';
        
        const iconUp = `<svg class="w-4 h-4 mr-1.5" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 15a.5.5 0 0 0 .5-.5V2.707l3.146 3.147a.5.5 0 0 0 .708-.708l-4-4a.5.5 0 0 0-.708 0l-4 4a.5.5 0 1 0 .708.708L7.5 2.707V14.5a.5.5 0 0 0 .5.5z"/></svg>`;
        const iconDown = `<svg class="w-4 h-4 mr-1.5" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 1a.5.5 0 0 1 .5.5v11.793l3.146-3.147a.5.5 0 0 1 .708.708l-4 4a.5.5 0 0 1-.708 0l-4 4a.5.5 0 0 1 .708-.708L7.5 13.293V1.5A.5.5 0 0 1 8 1z"/></svg>`;

        // Sistema de Roteamento
        class Router {
            constructor() {
                this.routes = {};
                this.init();
            }

            init() {
                window.addEventListener('popstate', () => {
                    this.handleRoute();
                });

                document.addEventListener('click', (e) => {
                    const link = e.target.closest('a[href^="/"]');
                    if (link && !link.hasAttribute('target')) {
                        e.preventDefault();
                        this.navigate(link.getAttribute('href'));
                    }
                });

                this.handleRoute();
            }

            navigate(path) {
                if (path !== window.location.pathname) {
                    window.history.pushState({}, '', path);
                }
                this.handleRoute();
            }

            handleRoute() {
                const path = window.location.pathname;
                
                // Rotas específicas
                if (path === '/') {
                    renderizarPaginaInicial();
                } else if (path === '/comparador') {
                    renderizarComparador();
                } else if (path === '/noticias') {
                    renderizarPaginaNoticias();
                } else if (path.startsWith('/comparador/')) {
                    const tickers = path.replace('/comparador/', '').split('-');
                    if (tickers.length === 2) {
                        renderizarComparador();
                        setTimeout(() => {
                            document.getElementById('comparadorInput1').value = tickers[0].toUpperCase();
                            document.getElementById('comparadorInput2').value = tickers[1].toUpperCase();
                            buscarECompararAtivos();
                        }, 100);
                    } else {
                        this.navigate('/comparador');
                    }
                } else if (path.match(/^\/[A-Z0-9-]+$/)) {
                    // Rota para ativo específico
                    const ticker = path.substring(1);
                    buscarAtivo(ticker);
                } else {
                    // Rota não encontrada, redireciona para home
                    this.navigate('/');
                }
            }
        }

        const router = new Router();

        // Função auxiliar para logos
        function getLogoHTML(ticker, quoteType, sizeClasses = 'w-10 h-10', extraClasses = 'rounded-full') {
            const placeholderUrl = `https://placehold.co/40x40/18181b/facc15?text=${ticker.charAt(0)}`;
            
            if (quoteType === 'CRYPTOCURRENCY') {
                const symbol = ticker.toLowerCase();
                const imageUrl = `crypto_logos/${symbol}.png`;
                return `<img src="${imageUrl}" alt="Logo ${ticker}" class="${sizeClasses} rounded-full object-contain" onerror="this.onerror=null;this.src='${placeholderUrl}';">`;
            } else if (quoteType === 'CURRENCY') {
                const symbol = ticker.substring(0, 3).toLowerCase(); 
                const imageUrl = `flags/${symbol}.png`;
                return `<img src="${imageUrl}" alt="Logo ${ticker}" class="${sizeClasses} ${extraClasses} object-contain" onerror="this.onerror=null;this.src='${placeholderUrl}';">`;
            } else if (quoteType === 'INDEX') {
                 return `<div class="${sizeClasses} ${extraClasses} bg-zinc-800 flex items-center justify-center"><span class="font-bold text-amber-400">${ticker.charAt(0)}</span></div>`;
            }
            else { 
                const pngUrl = `b3_logos/${ticker}.png`;
                const jpegUrl = `b3_logos/${ticker}.jpeg`;
                return `<img src="${pngUrl}" alt="Logo ${ticker}" class="${sizeClasses} ${extraClasses} object-contain" onerror="this.onerror=null; this.src='${jpegUrl}'; this.onerror=()=>{this.onerror=null; this.src='${placeholderUrl}'};">`;
            }
        }

        // Função para mostrar sugestões
        async function mostrarSugestoes(inputElement, suggestionBoxElement) {
            const termo = inputElement.value.toLowerCase();
            clearTimeout(debounceTimer);

            if (termo.length < 1) {
                suggestionBoxElement.classList.add('hidden');
                return;
            }

            debounceTimer = setTimeout(async () => {
                if (listaAtivosCompleta.length === 0) {
                    try {
                        const response = await fetch(`${apiUrl}/api/ativos/lista`);
                        listaAtivosCompleta = await response.json();
                    } catch (error) {
                        console.error('Erro ao carregar lista de ativos:', error);
                    }
                }

                const sugestoes = listaAtivosCompleta.filter(ativo => 
                    ativo.ticker.toLowerCase().includes(termo) || ativo.nome.toLowerCase().includes(termo)
                ).slice(0, 5);

                if (sugestoes.length > 0) {
                    suggestionBoxElement.innerHTML = sugestoes.map(s => `
                        <div data-ticker="${s.ticker}" class="suggestion-item p-3 cursor-pointer hover:bg-zinc-700 transition-colors border-b border-zinc-800 last:border-b-0 flex items-center space-x-3">
                            <div class="flex-shrink-0">${getLogoHTML(s.ticker, s.quoteType, 'w-6 h-6')}</div>
                            <div>
                                <span class="font-bold text-white">${s.ticker}</span>
                                <span class="text-gray-400 text-sm">- ${s.nome}</span>
                            </div>
                        </div>
                    `).join('');

                    suggestionBoxElement.querySelectorAll('.suggestion-item').forEach(item => {
                        item.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            const ticker = item.dataset.ticker;
                            router.navigate(`/${ticker}`);
                            suggestionBoxElement.classList.add('hidden');
                        });
                    });

                    suggestionBoxElement.classList.remove('hidden');
                } else {
                    suggestionBoxElement.classList.add('hidden');
                }
            }, 300);
        }

        // Função para mostrar sugestões específicas do comparador
        async function mostrarSugestoesComparador(inputElement, suggestionBoxElement) {
            const termo = inputElement.value.toLowerCase();
            clearTimeout(debounceTimer);

            if (termo.length < 1) {
                suggestionBoxElement.classList.add('hidden');
                return;
            }

            debounceTimer = setTimeout(async () => {
                if (listaAtivosCompleta.length === 0) {
                    try {
                        const response = await fetch(`${apiUrl}/api/ativos/lista`);
                        listaAtivosCompleta = await response.json();
                    } catch (error) {
                        console.error('Erro ao carregar lista de ativos:', error);
                    }
                }

                const sugestoes = listaAtivosCompleta.filter(ativo => 
                    ativo.ticker.toLowerCase().includes(termo) || ativo.nome.toLowerCase().includes(termo)
                ).slice(0, 5);

                if (sugestoes.length > 0) {
                    suggestionBoxElement.innerHTML = sugestoes.map(s => `
                        <div data-ticker="${s.ticker}" class="suggestion-item-comparador p-3 cursor-pointer hover:bg-zinc-700 transition-colors border-b border-zinc-800 last:border-b-0 flex items-center space-x-3">
                            <div class="flex-shrink-0">${getLogoHTML(s.ticker, s.quoteType, 'w-6 h-6')}</div>
                            <div>
                                <span class="font-bold text-white">${s.ticker}</span>
                                <span class="text-gray-400 text-sm">- ${s.nome}</span>
                            </div>
                        </div>
                    `).join('');

                    suggestionBoxElement.querySelectorAll('.suggestion-item-comparador').forEach(item => {
                        item.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            inputElement.value = item.dataset.ticker;
                            suggestionBoxElement.classList.add('hidden');
                            // NÃO navega para o ativo, apenas preenche o campo
                        });
                    });

                    suggestionBoxElement.classList.remove('hidden');
                } else {
                    suggestionBoxElement.classList.add('hidden');
                }
            }, 300);
        }
        
        // Função para renderizar página inicial
        function renderizarPaginaInicial(event) {
             if(event) event.preventDefault();
            mainContainer.innerHTML = `
                <div class="relative z-10 text-center py-16 md:py-21 fade-in-up">
                    <h1 class="text-4xl md:text-5xl font-extrabold text-white mb-4 leading-tight">
                        Análise de Ativos e <span class="text-amber-400"> Indicadores Financeiros</span>
                    </h1>
                    <p class="text-lg text-gray-400 mb-10 max-w-3xl mx-auto">
                        Dados, gráficos e indicadores para tomar as melhores decisões de investimento no mercado financeiro.
                    </p>
                    <div class="relative max-w-xl mx-auto">
                        <input type="text" id="heroSearchInput" placeholder="Buscar (ex: PETR4, BOVA11, Bitcoin)" class="w-full bg-zinc-900/50 border border-zinc-700 text-gray-200 px-6 py-4 rounded-full focus:outline-none focus:ring-2 focus:ring-amber-400 focus:border-amber-400 transition-all text-lg" autocomplete="off">
                        <button id="heroSearchButton" class="absolute inset-y-0 right-0 flex items-center pr-5 text-gray-400 hover:text-amber-400 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                        </button>
                        <div id="suggestion-box" class="absolute hidden w-full mt-2 card-background shadow-lg"></div>
                    </div>
                </div>
                <div id="homepage-content" class="mt-12">
                    <div class="flex justify-center items-center p-8"><div class="loader border-4 border-zinc-800 rounded-full w-12 h-12"></div></div>
                </div>
            `;

            const searchInput = document.getElementById('heroSearchInput');
            const searchButton = document.getElementById('heroSearchButton');
            const suggestionBox = document.getElementById('suggestion-box');

            searchInput.addEventListener('input', () => mostrarSugestoes(searchInput, suggestionBox));
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const termo = searchInput.value.trim();
                    if (termo) {
                        router.navigate(`/${termo.toUpperCase()}`);
                    }
                }
            });

            searchButton.addEventListener('click', () => {
                const termo = searchInput.value.trim();
                if (termo) {
                    router.navigate(`/${termo.toUpperCase()}`);
                }
            });

            // Esconde sugestões ao clicar fora
            document.addEventListener('click', (e) => {
                if (!searchInput.contains(e.target) && !suggestionBox.contains(e.target)) {
                    suggestionBox.classList.add('hidden');
                }
            });

            carregarDadosHomepage();
        }

        // Função para renderizar comparador
        function renderizarComparador(tipo = 'acoes', event) {
            if(event) event.preventDefault();
            mainContainer.innerHTML = `
                <div class="text-center py-12 fade-in-up">
                    <h1 class="text-4xl font-bold text-white mb-2">Comparador de Ativos</h1>
                    <p class="text-lg text-gray-400 mb-10">Selecione dois ativos para comparar seus indicadores e performance.</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8 fade-in-up" style="--animation-delay: 200ms;">
                    <div class="relative">
                        <input type="text" id="comparadorInput1" placeholder="Buscar Ativo 1..." class="w-full bg-zinc-900/50 border border-zinc-700 text-gray-200 px-6 py-3 rounded-full focus:outline-none focus:ring-2 focus:ring-amber-400 transition-all text-lg" autocomplete="off">
                        <div id="suggestion-box-1" class="absolute hidden w-full mt-2 card-background shadow-lg z-20 suggestion-box"></div>
                    </div>
                    <div class="relative">
                        <input type="text" id="comparadorInput2" placeholder="Buscar Ativo 2..." class="w-full bg-zinc-900/50 border border-zinc-700 text-gray-200 px-6 py-3 rounded-full focus:outline-none focus:ring-2 focus:ring-amber-400 transition-all text-lg" autocomplete="off">
                         <div id="suggestion-box-2" class="absolute hidden w-full mt-2 card-background shadow-lg z-20 suggestion-box"></div>
                    </div>
                </div>
                 <div class="text-center mb-12 fade-in-up" style="--animation-delay: 300ms;">
                    <button id="compareBtn" class="bg-amber-500 hover:bg-amber-600 text-black font-bold py-3 px-8 rounded-full transition-all transform hover:scale-105">Comparar</button>
                </div>
                <div id="comparison-results"></div>
            `;
            
            const input1 = document.getElementById('comparadorInput1');
            const suggestionBox1 = document.getElementById('suggestion-box-1');
            const input2 = document.getElementById('comparadorInput2');
            const suggestionBox2 = document.getElementById('suggestion-box-2');

            // Usa a função específica do comparador para sugestões
            input1.addEventListener('input', () => mostrarSugestoesComparador(input1, suggestionBox1));
            input2.addEventListener('input', () => mostrarSugestoesComparador(input2, suggestionBox2));
            
            // Permite busca com Enter
            input1.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    suggestionBox1.classList.add('hidden');
                    if (input1.value.trim() && input2.value.trim()) {
                        buscarECompararAtivos();
                    }
                }
            });
            
            input2.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    suggestionBox2.classList.add('hidden');
                    if (input1.value.trim() && input2.value.trim()) {
                        buscarECompararAtivos();
                    }
                }
            });
            
            // Esconder sugestões quando clicar fora
            document.addEventListener('click', (e) => {
                if (!input1.contains(e.target) && !suggestionBox1.contains(e.target)) {
                    suggestionBox1.classList.add('hidden');
                }
                if (!input2.contains(e.target) && !suggestionBox2.contains(e.target)) {
                    suggestionBox2.classList.add('hidden');
                }
            });

            document.getElementById('compareBtn').addEventListener('click', buscarECompararAtivos);
        }

        // Função para renderizar página de notícias
        function renderizarPaginaNoticias() {
            mainContainer.innerHTML = `
                <div class="fade-in-up">
                    <div class="text-center mb-12">
                        <h1 class="text-4xl md:text-5xl font-bold text-white mb-4">Notícias do Mercado</h1>
                        <p class="text-lg text-gray-400">Fique por dentro das últimas novidades do mercado financeiro</p>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="card-background card-hover p-6">
                            <div class="h-48 bg-zinc-800 rounded-lg mb-4 flex items-center justify-center">
                                <span class="text-gray-500">Imagem da notícia</span>
                            </div>
                            <h3 class="text-xl font-bold text-white mb-2">Mercado em alta nesta semana</h3>
                            <p class="text-gray-400 mb-4">Principais índices registram ganhos significativos com otimismo dos investidores...</p>
                            <span class="text-amber-400 text-sm">Há 2 horas</span>
                        </div>
                        
                        <div class="card-background card-hover p-6">
                            <div class="h-48 bg-zinc-800 rounded-lg mb-4 flex items-center justify-center">
                                <span class="text-gray-500">Imagem da notícia</span>
                            </div>
                            <h3 class="text-xl font-bold text-white mb-2">Petrobras anuncia novos investimentos</h3>
                            <p class="text-gray-400 mb-4">Empresa divulga plano estratégico para os próximos anos com foco em sustentabilidade...</p>
                            <span class="text-amber-400 text-sm">Há 4 horas</span>
                        </div>
                        
                        <div class="card-background card-hover p-6">
                            <div class="h-48 bg-zinc-800 rounded-lg mb-4 flex items-center justify-center">
                                <span class="text-gray-500">Imagem da notícia</span>
                            </div>
                            <h3 class="text-xl font-bold text-white mb-2">Bitcoin atinge nova máxima</h3>
                            <p class="text-gray-400 mb-4">Criptomoeda registra valorização expressiva impulsionada por fatores macroeconômicos...</p>
                            <span class="text-amber-400 text-sm">Há 6 horas</span>
                        </div>
                    </div>
                    
                    <div class="text-center mt-12">
                        <p class="text-gray-500">Funcionalidade de notícias em desenvolvimento</p>
                    </div>
                </div>
            `;
        }

        // Sistema de Lazy Loading otimizado
        let homepageDataCache = null;
        let isLoadingHomepage = false;

        // Função para carregar dados da homepage com lazy loading
        async function carregarDadosHomepage() {
            const homepageContent = document.getElementById('homepage-content');
            
            // Se já está carregando, não faz nova requisição
            if (isLoadingHomepage) return;
            
            // Se já tem dados em cache, usa eles
            if (homepageDataCache) {
                renderizarHomepageComCache();
                return;
            }
            
            isLoadingHomepage = true;
            
            try {
                // Carrega apenas os dados essenciais primeiro
                const response = await fetch(`${apiUrl}/api/homepage/essencial`);
                let data;
                
                if (response.ok) {
                    data = await response.json();
                } else {
                    // Fallback para API completa se a essencial não existir
                    const fullResponse = await fetch(`${apiUrl}/api/homepage`);
                    data = await fullResponse.json();
                }
                
                homepageDataCache = data;
                renderizarHomepageComCache();
                
                // Carrega dados adicionais em background
                setTimeout(() => carregarDadosAdicionais(), 1000);

            } catch (error) {
                console.error('Erro ao carregar homepage:', error);
                homepageContent.innerHTML = '<p class="text-red-500 text-center">Erro ao carregar dados da homepage. Tente novamente mais tarde.</p>';
            } finally {
                isLoadingHomepage = false;
            }
        }

        function renderizarHomepageComCache() {
            const homepageContent = document.getElementById('homepage-content');
            const data = homepageDataCache;
            
            // Renderiza apenas os primeiros 4 ativos populares
            const ativosIniciais = data.ativos_populares.slice(0, 4);
            const ativosRestantes = data.ativos_populares.slice(4);
            
            let homepageHTML = `
                <section class="mb-12 fade-in-up" style="--animation-delay: 0ms;">
                    <h2 class="text-3xl font-bold text-white mb-6">Ativos Populares</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6" id="popular-assets-container">
                        ${ativosIniciais.map(ativo => renderizarCardAtivo(ativo)).join('')}
                    </div>
                    ${ativosRestantes.length > 0 ? `
                        <div id="more-assets" class="hidden grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mt-6">
                            ${ativosRestantes.map(ativo => renderizarSkeletonAtivo()).join('')}
                        </div>
                        <div class="text-center mt-6">
                            <button id="load-more-assets" class="bg-amber-500 hover:bg-amber-600 text-black font-semibold py-2 px-6 rounded-full transition-colors">
                                Ver Mais Ativos
                            </button>
                        </div>
                    ` : ''}
                </section>

                <section class="mb-12 fade-in-up" style="--animation-delay: 100ms;">
                    <h2 class="text-3xl font-bold text-white mb-6">Rankings do Dia</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8" id="rankings-container">
                        ${renderizarRankingLazy('Maiores Altas', data.maiores_altas.slice(0, 3), 'altas')}
                        ${renderizarRankingLazy('Maiores Baixas', data.maiores_baixas.slice(0, 3), 'baixas')}
                        ${renderizarRankingLazy('Maiores Dividend Yields', data.maiores_dividend_yields.slice(0, 3), 'dividend-yields')}
                    </div>
                </section>

                <section class="mb-12 fade-in-up" style="--animation-delay: 200ms;">
                    <h2 class="text-3xl font-bold text-white mb-6">Cotações de Moedas e Criptos</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                        ${renderizarMoeda(data.bitcoin, 'btc')}
                        ${renderizarMoeda(data.ethereum, 'eth')}
                        ${renderizarMoeda(data.dolar, 'usd')}
                        ${renderizarMoeda(data.euro, 'eur')}
                    </div>
                </section>
            `;
            
            homepageContent.innerHTML = homepageHTML;
            
            // Adiciona event listener para "Ver Mais"
            const loadMoreBtn = document.getElementById('load-more-assets');
            if (loadMoreBtn) {
                loadMoreBtn.addEventListener('click', () => carregarMaisAtivos());
            }
        }

        function renderizarCardAtivo(ativo) {
            return `
                <a href="/${ativo.ticker}" class="card-background p-4 rounded-lg flex items-center space-x-4 card-hover">
                    <div class="flex-shrink-0">${getLogoHTML(ativo.ticker, ativo.quoteType)}</div>
                    <div>
                        <p class="text-lg font-bold text-white">${ativo.ticker}</p>
                        <p class="text-sm text-gray-400 truncate">${ativo.nome}</p>
                    </div>
                    <div class="ml-auto text-right">
                        <p class="text-lg font-bold text-white">${ativo.preco_atual}</p>
                        <p class="text-sm ${ativo.eh_positivo ? 'text-green-400' : 'text-red-400'}">${ativo.eh_positivo ? '+' : ''}${ativo.variacao_dia_pct}</p>
                    </div>
                </a>
            `;
        }

        function renderizarSkeletonAtivo() {
            return `
                <div class="card-background p-4 rounded-lg flex items-center space-x-4 animate-pulse">
                    <div class="flex-shrink-0 w-10 h-10 bg-zinc-700 rounded-full"></div>
                    <div class="flex-1">
                        <div class="h-4 bg-zinc-700 rounded mb-2"></div>
                        <div class="h-3 bg-zinc-800 rounded w-3/4"></div>
                    </div>
                    <div class="text-right">
                        <div class="h-4 bg-zinc-700 rounded mb-2 w-16"></div>
                        <div class="h-3 bg-zinc-800 rounded w-12"></div>
                    </div>
                </div>
            `;
        }

        function renderizarRankingLazy(titulo, dados, tipo) {
            return `
                <div class="card-background p-6 rounded-lg">
                    <h3 class="text-xl font-bold text-amber-400 mb-4">${titulo}</h3>
                    <div class="space-y-3">
                        ${dados.map(item => `
                            <a href="/${item.ticker}" class="flex items-center justify-between hover:bg-zinc-800 p-2 rounded-md transition-colors">
                                <div class="flex items-center space-x-3">
                                    ${getLogoHTML(item.ticker, item.quoteType, 'w-7 h-7')}
                                    <div>
                                        <p class="font-semibold text-white">${item.ticker}</p>
                                        <p class="text-xs text-gray-400">${item.nome}</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="font-bold text-white">${item.preco_atual}</p>
                                    <p class="text-sm ${item.eh_positivo ? 'text-green-400' : 'text-red-400'}">${item.eh_positivo ? '+' : ''}${item.variacao_dia_pct}</p>
                                </div>
                            </a>
                        `).join('')}
                    </div>
                    <div class="text-center mt-6">
                        <button onclick="carregarRankingCompleto('${tipo}')" class="text-amber-400 hover:text-amber-500 font-semibold transition-colors">Ver mais</button>
                    </div>
                </div>
            `;
        }

        async function carregarMaisAtivos() {
            const moreAssetsDiv = document.getElementById('more-assets');
            const loadMoreBtn = document.getElementById('load-more-assets');
            
            if (!homepageDataCache) return;
            
            loadMoreBtn.textContent = 'Carregando...';
            loadMoreBtn.disabled = true;
            
            // Simula carregamento
            await new Promise(resolve => setTimeout(resolve, 500));
            
            const ativosRestantes = homepageDataCache.ativos_populares.slice(4);
            moreAssetsDiv.innerHTML = ativosRestantes.map(ativo => renderizarCardAtivo(ativo)).join('');
            moreAssetsDiv.classList.remove('hidden');
            
            loadMoreBtn.style.display = 'none';
        }

        async function carregarDadosAdicionais() {
            // Carrega dados adicionais em background para melhorar a experiência
            try {
                const response = await fetch(`${apiUrl}/api/homepage/completo`);
                if (response.ok) {
                    const dadosCompletos = await response.json();
                    // Atualiza cache com dados completos
                    homepageDataCache = { ...homepageDataCache, ...dadosCompletos };
                }
            } catch (error) {
                console.log('Dados adicionais não disponíveis:', error);
            }
        }

        async function carregarRankingCompleto(tipo) {
            // Implementa carregamento do ranking completo
            console.log(`Carregando ranking completo: ${tipo}`);
            // Aqui você pode implementar um modal ou navegação para página de ranking
        }

        function renderizarRanking(titulo, dados, tipo) {
            return `
                <div class="card-background p-6 rounded-lg">
                    <h3 class="text-xl font-bold text-amber-400 mb-4">${titulo}</h3>
                    <div class="space-y-3">
                        ${dados.map(item => `
                            <a href="/${item.ticker}" class="flex items-center justify-between hover:bg-zinc-800 p-2 rounded-md transition-colors">
                                <div class="flex items-center space-x-3">
                                    ${getLogoHTML(item.ticker, item.quoteType, 'w-7 h-7')}
                                    <div>
                                        <p class="font-semibold text-white">${item.ticker}</p>
                                        <p class="text-xs text-gray-400">${item.nome}</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="font-bold text-white">${item.preco_atual}</p>
                                    <p class="text-sm ${item.eh_positivo ? 'text-green-400' : 'text-red-400'}">${item.eh_positivo ? '+' : ''}${item.variacao_dia_pct}</p>
                                </div>
                            </a>
                        `).join('')}
                    </div>
                    <div class="text-center mt-6">
                        <a href="/ranking/${tipo}" class="text-amber-400 hover:text-amber-500 font-semibold transition-colors">Ver mais</a>
                    </div>
                </div>
            `;
        }

        function renderizarMoeda(moeda, tipo) {
            const corVariacao = moeda.eh_positivo ? 'text-green-400' : 'text-red-400';
            const sinalVariacao = moeda.eh_positivo ? '+' : '';
            let logoPath = `flags/${tipo}.png`;
            if (tipo === 'btc' || tipo === 'eth') {
                logoPath = `crypto_logos/${tipo}.png`;
            }

            return `
                <a href="/moeda/${tipo}" class="card-background p-4 rounded-lg flex items-center space-x-4 card-hover">
                    <div class="flex-shrink-0">
                        <img src="${logoPath}" alt="${moeda.nome} Logo" class="w-8 h-8 rounded-full">
                    </div>
                    <div>
                        <p class="text-lg font-bold text-white">${moeda.nome}</p>
                        <p class="text-sm text-gray-400">${moeda.simbolo}</p>
                    </div>
                    <div class="ml-auto text-right">
                        <p class="text-lg font-bold text-white">${moeda.preco_brl}</p>
                        <p class="text-sm ${corVariacao}">${sinalVariacao}${moeda.variacao_dia_pct}</p>
                    </div>
                </a>
            `;
        }

        // Função para buscar ativo
        async function buscarAtivo(ticker, periodo = '1y') {
            mainContainer.innerHTML = `
                <div class="flex justify-center items-center py-20">
                    <div class="text-center">
                        <div class="loader border-4 border-zinc-800 rounded-full w-12 h-12 mx-auto mb-4"></div>
                        <p class="text-gray-400">Analisando ${ticker}...</p>
                    </div>
                </div>
            `;

            try {
                const response = await fetch(`${apiUrl}/api/ativo/${ticker}?periodo=${periodo}`);
                const ativo = await response.json();
                renderizarPaginaAtivo(ativo);
                if (ativo.historico_grafico) {
                    setTimeout(() => inicializarGrafico(ativo.historico_grafico, periodo, 'priceChart'), 100);
                }
            } catch (error) {
                console.error('Erro ao carregar ativo:', error);
                mainContainer.innerHTML = `<p class="text-red-500 text-center py-20">Erro ao carregar dados do ativo ${ticker}. Tente novamente mais tarde.</p>`;
            }
        }

        // Função para renderizar página do ativo
        function renderizarPaginaAtivo(ativo) {
            currentTicker = ativo.ticker;
            const corVariacao = ativo.eh_positivo ? 'text-green-400' : 'text-red-400';
            const sinalVariacao = ativo.eh_positivo ? '+' : '';

            let secoesHTML = '';
            if(ativo.secoes && ativo.secoes.length > 0) {
                secoesHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-x-8 gap-y-6">
                    <div class="space-y-6">
                        <div>
                            <h4 class="text-lg font-bold text-amber-400 mb-2">${(ativo.secoes[0] || { titulo: 'Valuation' }).titulo}</h4>
                            ${(ativo.secoes[0] || { indicadores: [] }).indicadores.map(item => `<div class="flex justify-between py-2 border-b border-zinc-800 text-sm"><span class="text-gray-400">${item.label}</span><span class="font-medium text-white">${item.value}</span></div>`).join('')}
                        </div>
                        ${ativo.secoes[2] ? `
                        <div>
                            <h4 class="text-lg font-bold text-amber-400 mb-2">${ativo.secoes[2].titulo}</h4>
                            ${ativo.secoes[2].indicadores.map(item => `<div class="flex justify-between py-2 border-b border-zinc-800 text-sm"><span class="text-gray-400">${item.label}</span><span class="font-medium text-white">${item.value}</span></div>`).join('')}
                        </div>
                        ` : ''}
                    </div>
                    <div class="space-y-6">
                        ${ativo.secoes[1] ? `
                        <div>
                            <h4 class="text-lg font-bold text-amber-400 mb-2">${ativo.secoes[1].titulo}</h4>
                            ${ativo.secoes[1].indicadores.map(item => `<div class="flex justify-between py-2 border-b border-zinc-800 text-sm"><span class="text-gray-400">${item.label}</span><span class="font-medium text-white">${item.value}</span></div>`).join('')}
                        </div>
                        ` : ''}
                        ${ativo.secoes[3] ? `
                        <div>
                            <h4 class="text-lg font-bold text-amber-400 mb-2">${ativo.secoes[3].titulo}</h4>
                            ${ativo.secoes[3].indicadores.map(item => `<div class="flex justify-between py-2 border-b border-zinc-800 text-sm"><span class="text-gray-400">${item.label}</span><span class="font-medium text-white">${item.value}</span></div>`).join('')}
                        </div>
                        ` : ''}
                    </div>
                </div>
                `;
            }

            mainContainer.innerHTML = `
                <div class="fade-in-up">
                    <div class="card-background p-4 md:p-6 mb-8">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
                            <div class="flex items-center space-x-4 mb-4 md:mb-0">
                                ${getLogoHTML(ativo.ticker, ativo.quoteType, 'w-12 h-12 md:w-16 md:h-16', 'rounded-xl')}
                                <div>
                                    <h1 class="text-2xl md:text-3xl font-bold text-white">${ativo.ticker}</h1>
                                    <p class="text-gray-400 text-sm md:text-base">${ativo.nome}</p>
                                    <p class="text-gray-500 text-xs md:text-sm">${ativo.tipo_ativo}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-2xl md:text-3xl font-bold text-white">${ativo.preco_atual}</p>
                                <p class="text-lg md:text-xl font-semibold ${corVariacao}">${sinalVariacao}${ativo.variacao_dia_abs} (${ativo.variacao_dia_pct})</p>
                            </div>
                        </div>
                        ${secoesHTML}
                    </div>
                    <div class="card-background p-4 md:p-6 fade-in-up" style="--animation-delay: 200ms;">
                        <div class="flex flex-col space-y-4 mb-6">
                            <h3 class="text-xl md:text-2xl font-bold text-white">Histórico de Preços</h3>
                            <div class="flex flex-wrap gap-2 justify-center md:justify-start period-buttons">
                                ${['1D', '5D', '1M', '3M', '6M', '1Y', '5Y', 'MAX'].map(p => 
                                    `<button onclick="mudarPeriodoGrafico('${p.toLowerCase()}')" class="px-3 py-1.5 text-sm font-medium rounded-md transition-colors text-gray-400 hover:bg-zinc-700 hover:text-amber-400 whitespace-nowrap" data-periodo="${p.toLowerCase()}">${p}</button>`
                                ).join('')}
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="priceChart" class="w-full h-full"></canvas>
                        </div>
                    </div>
                </div>
            `;
        }

        // Função para comparar ativos
        async function buscarECompararAtivos() {
            const ticker1 = document.getElementById('comparadorInput1').value.toUpperCase();
            const ticker2 = document.getElementById('comparadorInput2').value.toUpperCase();

            if (!ticker1 || !ticker2) {
                alert('Por favor, insira dois tickers para comparar.');
                return;
            }

            document.getElementById('comparison-results').innerHTML = `
                <div class="flex justify-center items-center py-20">
                    <div class="text-center">
                        <div class="loader border-4 border-zinc-800 rounded-full w-12 h-12 mx-auto mb-4"></div>
                        <p class="text-gray-400">Comparando ${ticker1} vs ${ticker2}...</p>
                    </div>
                </div>
            `;

            try {
                const response = await fetch(`${apiUrl}/api/comparar/${ticker1}/${ticker2}`);
                const data = await response.json();
                renderizarResultadoComparacao(data, '1y');
                
                // Atualiza a URL para refletir a comparação
                router.navigate(`/comparador/${ticker1.toLowerCase()}-${ticker2.toLowerCase()}`);
            } catch (error) {
                console.error('Erro ao comparar ativos:', error);
                document.getElementById('comparison-results').innerHTML = '<p class="text-red-500 text-center">Erro ao comparar ativos. Verifique os tickers e tente novamente.</p>';
            }
        }

        // Função para renderizar resultado da comparação
        function renderizarResultadoComparacao(data, periodo) {
            const resultsDiv = document.getElementById('comparison-results');
            const { ativo1, ativo2, indicadores_comparativos, historico_normalizado } = data;
            
            const header1 = `
                <div class="flex items-center space-x-4">
                    ${getLogoHTML(ativo1.ticker, ativo1.quoteType, 'w-12 h-12', 'rounded-xl')}
                    <div>
                        <p class="text-xl font-bold text-white">${ativo1.ticker}</p>
                        <p class="text-sm text-gray-400 truncate">${ativo1.nome}</p>
                    </div>
                </div>`;
            
            const header2 = `
                <div class="flex items-center space-x-4">
                     ${getLogoHTML(ativo2.ticker, ativo2.quoteType, 'w-12 h-12', 'rounded-xl')}
                    <div>
                        <p class="text-xl font-bold text-white">${ativo2.ticker}</p>
                        <p class="text-sm text-gray-400 truncate">${ativo2.nome}</p>
                    </div>
                </div>`;
            
            let tabelaHTML = '';
            indicadores_comparativos.forEach(item => {
                const winner1Class = item.winner === 1 ? 'text-green-400 font-bold' : 'text-white';
                const winner2Class = item.winner === 2 ? 'text-green-400 font-bold' : 'text-white';

                tabelaHTML += `
                    <div class="grid grid-cols-3 items-center text-center py-3 border-b border-zinc-800 comparison-table">
                        <span class="${winner1Class} text-sm md:text-base">${item.valor1}</span>
                        <span class="text-gray-400 text-xs md:text-sm">${item.label}</span>
                        <span class="${winner2Class} text-sm md:text-base">${item.valor2}</span>
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = `
                <div class="card-background p-4 md:p-6 mb-8 fade-in-up">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        ${header1}
                        ${header2}
                    </div>
                    <div class="mt-8 overflow-x-auto">${tabelaHTML}</div>
                </div>
                <div class="card-background p-4 md:p-6 fade-in-up" style="--animation-delay: 200ms;">
                    <div class="flex flex-col space-y-4 mb-6">
                        <h3 class="text-xl md:text-2xl font-bold text-white">Performance Normalizada (Base 100)</h3>
                        <div class="flex flex-wrap gap-2 justify-center md:justify-start period-buttons">
                            ${['1M', '3M', '6M', '1Y', '5Y', 'MAX'].map(p => 
                                `<button onclick="mudarPeriodoGrafico('${p.toLowerCase()}')" class="px-3 py-1.5 text-sm font-medium rounded-md transition-colors text-gray-400 hover:bg-zinc-700 hover:text-amber-400 whitespace-nowrap" data-periodo="${p.toLowerCase()}">${p}</button>`
                            ).join('')}
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="comparativoChart" class="w-full h-full"></canvas>
                    </div>
                </div>
            `;
            
            setTimeout(() => inicializarGraficoComparativo(historico_normalizado), 100);
        }

        // Funções de gráficos
        let priceChartInstance = null;
        let comparativoChartInstance = null;

        function inicializarGrafico(historico, periodoInicial, canvasId) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            const labels = historico.map(item => new Date(item.data));
            const data = historico.map(item => item.fechamento);

            const chartConfig = {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Preço',
                        data: data,
                        borderColor: '#facc15',
                        backgroundColor: 'rgba(250, 204, 21, 0.2)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        hoverRadius: 5,
                        pointBackgroundColor: '#facc15',
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return new Date(context[0].label).toLocaleDateString('pt-BR');
                                },
                                label: function(context) {
                                    return `Preço: R$ ${context.parsed.y.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day',
                                tooltipFormat: 'dd/MM/yyyy',
                                displayFormats: {
                                    day: 'dd/MM/yyyy',
                                    month: 'MMM yyyy',
                                    year: 'yyyy'
                                }
                            },
                            ticks: { color: '#a1a1aa' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            ticks: { color: '#a1a1aa' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            };

            if (canvasId === 'priceChart') {
                if (priceChartInstance) priceChartInstance.destroy();
                priceChartInstance = new Chart(ctx, chartConfig);
            }
        }

        function inicializarGraficoComparativo(historico_normalizado) {
            const ctx = document.getElementById('comparativoChart').getContext('2d');
            
            if (comparativoChartInstance) comparativoChartInstance.destroy();
            
            const labels = historico_normalizado.datas.map(data => new Date(data));
            
            comparativoChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: historico_normalizado.ticker1,
                            data: historico_normalizado.valores1,
                            borderColor: '#facc15',
                            backgroundColor: 'rgba(250, 204, 21, 0.1)',
                            fill: false,
                            tension: 0.4,
                            pointRadius: 0,
                            hoverRadius: 5,
                        },
                        {
                            label: historico_normalizado.ticker2,
                            data: historico_normalizado.valores2,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            fill: false,
                            tension: 0.4,
                            pointRadius: 0,
                            hoverRadius: 5,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: { 
                            display: true,
                            labels: { color: '#a1a1aa' }
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return new Date(context[0].label).toLocaleDateString('pt-BR');
                                },
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day',
                                tooltipFormat: 'dd/MM/yyyy',
                                displayFormats: {
                                    day: 'dd/MM/yyyy',
                                    month: 'MMM yyyy',
                                    year: 'yyyy'
                                }
                            },
                            ticks: { color: '#a1a1aa' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            ticks: { color: '#a1a1aa' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });
        }

        async function mudarPeriodoGrafico(periodo) {
            console.log(`Mudar período do gráfico para: ${periodo}`);
            if (currentTicker) {
                await buscarAtivo(currentTicker, periodo);
            }
        }

        // Menu mobile
        function fecharMenuMobile() {
            document.getElementById('mobile-menu').classList.add('translate-x-full');
            document.getElementById('menu-overlay').classList.remove('bg-opacity-50');
            document.getElementById('menu-overlay').classList.add('pointer-events-none');
        }

        document.getElementById('hamburger-btn').addEventListener('click', () => {
            document.getElementById('mobile-menu').classList.remove('translate-x-full');
            document.getElementById('menu-overlay').classList.add('bg-opacity-50');
            document.getElementById('menu-overlay').classList.remove('pointer-events-none');
        });

        document.getElementById('close-menu-btn').addEventListener('click', fecharMenuMobile);
        document.getElementById('menu-overlay').addEventListener('click', fecharMenuMobile);

        // Inicialização
        document.addEventListener('DOMContentLoaded', () => {
            // O router já foi inicializado
        });
    </script>
</body>
</html>

